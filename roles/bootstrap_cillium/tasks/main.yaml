- name: Add cillium chart repo
  kubernetes.core.helm_repository:
    name: cilium
    repo_url: "https://helm.cilium.io/"
    kubeconfig: /etc/kubernetes/admin.conf
  when: inventory_hostname == 'k8s-control'
  delegate_to: localhost  
  become: false

- name: Deploy cilium with helm
  kubernetes.core.helm:
    name: cilium
    chart_ref: cilium/cilium
    release_namespace: kube-system
    chart_version: "{{ CILIUM_VERSION }}"
    kubeconfig: /etc/kubernetes/admin.conf
    values:
      replicas: 1
    set_values:
      - value: "kubeProxyReplacement=true"
      - value: "k8sServiceHost={{ lookup('env', 'K8S_CONTROL_IP') }}"
      - value: "k8sServicePort=6443"
      - value: "operator.replicas=1"
      - value: "hubble.ui.enabled=true"
      - value: "hubble.ui.replicas=1"
      - value: "hubble.relay.enabled=true"
      - value: "hubble.relay.replicas=1"
      - value: "hubble.tls.auto.enabled=true"
      - value: "hubble.tls.auto.method=cronJob"
      - value: "hubble.tls.auto.certValidityDuration=1095"
      - value: "hubble.tls.auto.schedule=\"0 0 1 */4 *\""
      - value: "l2announcements.enabled=true"
      - value: "encryption.enabled=true"
      - value: "encryption.type=wireguard"
    update_repo_cache: true
  register: cilium_installed
  when: inventory_hostname == 'k8s-control'
  delegate_to: localhost
  become: false

- name: restart coredns pods to pickup new kube-dns IP
  ansible.builtin.shell: |
    kubectl -n kube-system rollout restart deployment coredns
  when: cilium_installed.changed and inventory_hostname == 'k8s-control'
  delegate_to: localhost
  become: false

- name: create CiliumLoadBalancerIPPool
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: "cilium.io/v2"
      kind: CiliumLoadBalancerIPPool
      metadata:
        name: "cilium-loadbalancer-ippool"
      spec:
        blocks:
        - cidr: "{{ CILIUM_LOADBALANCER_IPPOOL }}"
  when: inventory_hostname == 'k8s-control'
  delegate_to: localhost
  become: false

- name: create L2announcement policy
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: "cilium.io/v2alpha1"
      kind: CiliumL2AnnouncementPolicy
      metadata:
        name: "cilium-{{ inventory_hostname }}-l2announcement-policy"
      spec:
        interfaces:
        - "{{ ansible_facts.default_ipv4.interface }}"
        externalIPs: true
        loadBalancerIPs: true
  when: inventory_hostname in groups['k8s-nodes']
  delegate_to: localhost
  become: false
